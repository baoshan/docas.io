// Generated by CoffeeScript 1.3.1
(function() {
  var arr, bind, detail_bind, init, select_index, statistics, timer_id;

  arr = ['<table class="table table-bordered overview">', '<thead><tr><th>Queue</th><th>Workers</th><th>Avg. Time</th><th>Total</th><th>Finished</th><th>Processing</th><th>Pending</th><th>Failed</th><th>Blocked</th><th>Schedule</th><th>Clear</th></tr></thead>', '<tbody>', '<% _.each(data, function(item){ %>', '<tr key=mykey>', '<td><%= item.name %></td><td><%= item.workers%></td><td><%= item.average_pending_time%></td><td><span><%= item.total.tasks%></span><span>/</span><span><%= item.total.groups%><span></td><td><%= item.finished_tasks%></td><td><%= item.processing_tasks%></td><td><%= item.pending_tasks%></td><td><%= item.failed_tasks%></td><td><span><%= item.blocked.tasks%></span><span>/</span><span><%= item.blocked.groups%><span></td><td><button class="btn_reschedule">Schedule</button></td><td><button class="btn_clear">Clear</button></td>', '</tr>', '<%})%>', '<tr>', '<td>Total</td><td><%= _.reduce(data, function(memo, item){ return memo + Number(item.workers); }, 0)%></td><td><%= _.reduce(data, function(memo, item){ return memo + Number(item.average_pending_time); }, 0)%></td><td><span><%= _.reduce(data, function(memo, item){ return memo + Number(item.total.tasks); }, 0)%></span><span>/</span><span><%= _.reduce(data, function(memo, item){ return memo + Number(item.total.groups); }, 0) %></span></td><td><%= _.reduce(data, function(memo, item){ return memo + Number(item.finished_tasks); }, 0)%></td><td><%= _.reduce(data, function(memo, item){ return memo + Number(item.processing_tasks); }, 0)%></td><td><%= _.reduce(data, function(memo, item){ return memo + Number(item.pending_tasks); }, 0)%></td><td><%= _.reduce(data, function(memo, item){ return memo + Number(item.failed_tasks); }, 0)%></td><td><span><%= _.reduce(data, function(memo, item){ return memo + Number(item.blocked.tasks); }, 0)%></span><span>/</span><span><%= _.reduce(data, function(memo, item){ return memo + Number(item.blocked.groups); }, 0)%></span></td><td>&nbsp;</td><td>&nbsp;</td>', '</tr>', '</tbody>', '</table>'];

  statistics = [];

  select_index = 0;

  timer_id = 0;

  init = function() {
    console.log((new Date).toString());
    return $.ajax({
      type: 'GET',
      url: '/api/queues/statistics',
      success: function(data) {
        var name, select_value;
        statistics = data;
        $('#m_statistics').html(_.template(arr.join(''), {
          data: data
        }));
        if ($('#queque_detail').is(":visible")) {
          $($('#m_statistics').find('tr')[select_index]).attr("id", "active");
          name = $($($('#m_statistics').find('tr')[select_index]).find('td:first')).html();
          detail_bind(name);
        }
        select_value = $("select").find("option:selected").text();
        return timer_id = setTimeout((function() {
          return init();
        }), select_value.substring(0, select_value.length - 1) * 1000);
      }
    });
  };

  $(document).ready(function() {
    $('select').find("option:nth-child(1)").attr("selected", "true");
    $('#queque_detail').hide();
    init();
    return bind();
  });

  bind = function() {
    $('#m_statistics tr[key=mykey]').live('click', function() {
      var name;
      $($('#m_statistics').find('tr')[select_index]).removeAttr('id');
      $(this).attr("id", "active");
      name = $($(this).find('td')[0]).html();
      select_index = $(this).parent().index();
      detail_bind(name);
      return $('#queque_detail').show();
    });
    return ['reschedule', 'clear'].map(function(command) {
      return (function(command) {
        return $("#m_statistics .btn_" + command).live('click', function(event) {
          var name, that;
          event.stopPropagation();
          name = $(this).parent().parent().find('td:first').html();
          that = this;
          return $.ajax({
            type: 'POST',
            url: '/api/queues/' + name + ("/" + command),
            success: function(result) {
              var index;
              index = $(that).parent().parent().index();
              $(that).parent().parent().html(_.template(arr[5], {
                item: result
              }));
              statistics[index] = result;
              return $('#m_statistics tr:last').html(_.template(arr[9], {
                data: statistics
              }));
            }
          });
        });
      })(command);
    });
  };

  detail_bind = function(name) {
    return ['statistics', 'recently_finished_tasks', 'failed_tasks', 'slowest_tasks', 'processing_tasks', 'workers'].map(function(command) {
      return (function(command) {
        return $.ajax({
          type: 'GET',
          url: '/api/queues/' + name + ("/" + command),
          success: function(results) {
            var param;
            param = {};
            param[command] = results;
            $("#s_" + command).html(_.template($("#tb_" + command + "_template").html(), param));
            if (command === 'failed_tasks') {
              $(".failed_popover").find(".nav-tabs>li:first").addClass("active");
              return $(".failed_popover").find(".tab-content>div:first").addClass("active");
            }
          }
        });
      })(command);
    });
  };

  $("select").change(function() {
    clearTimeout(timer_id);
    return init();
  });

  $('.icon-th').click(function() {
    $('#workers + .tabbable').addClass('xz');
    $(this).addClass('active');
    return $('.icon-th-large').removeClass('active');
  });

  $('.icon-th-large').click(function() {
    $('#workers + .tabbable').removeClass('xz');
    $(this).addClass('active');
    return $('.icon-th').removeClass('active');
  });

  $(document).scroll(function() {
    var scroll_top;
    scroll_top = $(document).scrollTop();
    if (scroll_top > 40) {
      return $('h1').addClass("h1_shadow");
    } else {
      return $('h1').removeClass("h1_shadow");
    }
  });

  this.parse_milliseconds = function(milli) {
    var second;
    second = milli / 1000;
    if (second < 1) {
      return milli + 'ms';
    }
    if ((1 < second && second < 60)) {
      return Math.floor(second) + 's';
    }
    if (second > 60) {
      return Math.floor(second / 60) + 'm' + ':' + Math.floor(second % 60) + 's';
    }
  };

  this.id_factory = function() {
    var i;
    i = 0;
    return {
      "new": function() {
        return i++;
      }
    };
  };

}).call(this);
